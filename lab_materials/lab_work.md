# Лабораторная работа №2

**Тема:** подключение учебного UI к backend‑API и устранение проблемы CORS.

**Целевая аудитория:** начинающие студенты, выполняющие первую практику по
взаимодействию фронтенда и бэкенда.

## 1. Цель работы

Освоить подключение веб‑клиента на Rust (Yew) к внешнему API, увидеть типичную
ошибку CORS, научиться диагностировать её и применять корректные решения в
учебной среде.

## 2. Ожидаемые результаты

После выполнения работы студент должен уметь:

1. Запустить backend и frontend как два независимых процесса.
2. Проверить доступность API из UI (экран «Статус API»).
3. Отправить вопрос через UI и получить ответ.
4. Определить, что ошибка «Failed to fetch» связана с CORS.
5. Описать и применить один из способов устранения CORS в учебной среде.

## 3. Теоретические сведения (кратко и по делу)

### 3.1. Что такое HTTP‑запрос

HTTP‑запрос — это сообщение клиента серверу (например, браузера к API), которое
содержит метод (GET, POST), путь (`/health`, `/ask`), заголовки и, при необходимости,
тело запроса. Ответ сервера включает код статуса (200, 400, 500 и др.) и данные.

### 3.2. Что такое «origin»

**Origin** — это комбинация трёх частей адреса:

- протокол (например, `http`),
- домен или IP (например, `127.0.0.1`),
- порт (например, `8080`).

Примеры разных origin:

- `http://127.0.0.1:8080` — один origin,
- `http://127.0.0.1:8000` — другой origin (порт отличается).

### 3.3. Политика одинакового происхождения (same‑origin policy)

Браузер по умолчанию **запрещает** запросы между разными origin. Это базовая
мера безопасности для защиты пользователя.

### 3.4. Что такое CORS

**CORS (Cross‑Origin Resource Sharing)** — механизм, который позволяет серверу
явно разрешить запросы из другого origin. Разрешение задаётся через HTTP‑заголовки
в ответе сервера.

Минимальный пример разрешения:

- `Access-Control-Allow-Origin: http://127.0.0.1:8080`

### 3.5. Предварительный запрос (preflight)

Некоторые запросы (например, `POST` с `Content-Type: application/json`) требуют
дополнительной проверки. Браузер сначала отправляет `OPTIONS`‑запрос, и только
после положительного ответа выполняет основной запрос.

Если сервер не обрабатывает `OPTIONS` или не возвращает нужные заголовки, то
браузер блокирует основной запрос.

## 4. Исходные материалы

Перед работой рекомендуется ознакомиться с основной документацией проекта:

- `docs/build_and_run.md` — запуск и сборка UI;
- `docs/api_contract.md` — формат запросов и ответов;
- `docs/common_issues.md` — частые проблемы (включая CORS);
- `docs/ui_ux_requirements.md` — требования к интерфейсу;
- `docs/stack_guide.md` — обзор ключевых библиотек.

## 5. Подготовка окружения

1. Убедиться, что установлен Rust и цель `wasm32-unknown-unknown`:

```bash
rustup target add wasm32-unknown-unknown
```

2. Установить Trunk:

```bash
cargo install trunk
```

3. Запустить backend (в отдельном терминале):

```bash
cd /path/to/rust-gigachat-app
cargo run
```

## 6. Ход работы

### Шаг 1. Запуск UI

```bash
cd /path/to/rust-gigachat-webapp
NO_COLOR=true trunk serve --address 127.0.0.1 --port 8080
```

После запуска открыть в браузере:

```
http://127.0.0.1:8080
```

### Шаг 2. Проверка статуса API

На экране «Статус API» нажать кнопку «Проверить». При корректной настройке
сервер должен вернуть статус `ok`, версию и режим работы.

### Шаг 3. Отправка вопроса

В поле «Ваш вопрос» ввести любой текст, например:

```
Что такое Rust?
```

Нажать кнопку «Отправить». В ответе должна появиться строка `answer`.

## 7. Типовая проблема: CORS

### 7.1. Симптомы

При нажатии «Проверить» или «Отправить» интерфейс показывает сообщение:

- «Ошибка шлюза: Сетевая ошибка: TypeError: Failed to fetch»

В консоли браузера появляется сообщение вида:

- `blocked by CORS policy`.

### 7.2. Причина

UI работает на `http://127.0.0.1:8080`, а API — на `http://127.0.0.1:8000`.
Это разные origin. Если backend не разрешил запросы через CORS‑заголовки,
браузер блокирует обмен данными.

### 7.3. Диагностика

1. Открыть инструменты разработчика в браузере.
2. На вкладке **Network** найти запрос `/health` или `/ask`.
3. Проверить наличие заголовка `Access-Control-Allow-Origin` в ответе.
4. Если заголовка нет — это подтверждает проблему CORS.

## 8. Решения проблемы CORS (учебные варианты)

Ниже перечислены корректные способы устранения CORS. В учебной среде допустимо
использовать любой из них по указанию преподавателя.

### Вариант A. Настройка CORS на backend (рекомендуемый)

**Суть:** сервер явно разрешает запросы от UI.

Что требуется от backend:

- добавлять заголовок `Access-Control-Allow-Origin`;
- отвечать на `OPTIONS`‑запросы;
- разрешить методы `GET, POST` и заголовок `Content-Type`.

Минимально необходимые заголовки:

- `Access-Control-Allow-Origin: http://127.0.0.1:8080`
- `Access-Control-Allow-Methods: GET, POST, OPTIONS`
- `Access-Control-Allow-Headers: Content-Type`

**Примечание:** в учебной среде допустимо временно использовать
`Access-Control-Allow-Origin: *`, но для реальных систем предпочтительно
указывать конкретный origin.

### Вариант B. Прокси в Trunk (без изменения backend)

**Суть:** UI и прокси работают на одном origin, а запросы прозрачно
переадресуются к backend.

Пример возможной конфигурации `Trunk.toml`:

```toml
[serve]
address = "127.0.0.1"
port = 8080

[[proxy]]
backend = "http://127.0.0.1:8000"
rewrite = "/api"
```

После этого:

1. В UI установить базовый URL как `http://127.0.0.1:8080/api`.
2. Запустить `trunk serve`.
3. Запрос `http://127.0.0.1:8080/api/health` будет перенаправлен на backend.

**Важно:** это учебный способ для локальной разработки. В продакшене
используются специализированные прокси или настройка CORS на сервере.

### Вариант C. Общий origin

**Суть:** UI и API обслуживаются одним сервером и одним портом. Тогда CORS
не возникает. Этот вариант используется в некоторых монолитных конфигурациях,
но в учебном проекте применяется редко, так как скрывает разделение фронтенда
и бэкенда.

## 9. Проверка результата

Результат считается корректным, если:

1. Запрос `GET /health` возвращает статус без ошибки CORS.
2. В UI отображается статус сервера и его версия.
3. Запрос `POST /ask` возвращает текст ответа.
4. В консоли браузера нет сообщений о CORS‑блокировке.

## 10. Контрольные вопросы

1. Что такое origin и почему порты важны?
2. В каких случаях браузер выполняет preflight‑запрос?
3. Какие заголовки должен вернуть сервер, чтобы разрешить CORS?
4. Чем отличается настройка CORS на сервере от прокси в Trunk?
5. Почему `Access-Control-Allow-Origin: *` нежелателен в реальных системах?

## 11. Критерии оценивания (ориентир)

- **Базовый уровень (удовлетворительно):** UI запускается, студент объясняет
  причину CORS.
- **Средний уровень (хорошо):** студент находит заголовки в ответе сервера,
  корректно описывает preflight.
- **Высокий уровень (отлично):** студент реализует одно из решений и
  демонстрирует успешную работу UI.

## 12. Требования по безопасности и подготовке материалов

Перед сдачей или публикацией результатов работы:

1. **Не коммитьте секреты и локальные настройки** (`.env`, токены, приватные ключи).
2. **Проверьте историю git** на наличие секретов:
   ```bash
   git log -p --all | grep -i "api-key\\|token\\|secret"
   ```
3. **Убедитесь, что UI работает с backend через API**, а не напрямую с GigaChat.
4. **Проверьте запуск двух серверов** по инструкции из `docs/build_and_run.md`.

## 13. Дополнительные материалы по Git и GitHub

Для подключения локального репозитория к GitHub через SSH и работы с удаленными
репозиториями используйте отдельный практический гайд:

- `lab_materials/git_github_setup.md`
  - включает объяснение, почему пароль может запрашиваться при каждом запуске терминала,
    и как настроить «постоянный» `ssh-agent` для WSL.

Для базовых операций с версиями используйте:

- `lab_materials/git_version_control.md`

## 14. Работа с задачами (beads)

В проекте используется встроенный issue‑трекер **beads**. Базовый workflow
и рекомендации для учебной работы описаны в документе:

- `lab_materials/beads_guide.md`

**Обязательное требование для задач:**  
создавайте задачи с кратким описанием (`--description`), чтобы сохранять контекст.
Это повышает воспроизводимость и упрощает проверку.
