# Практикум: Beads и единый workflow с Git

Этот проект использует **beads** как встроенный issue‑трекер. Beads хранит задачи
прямо в репозитории (в `.beads/issues.jsonl`) и синхронизируется с git‑историей.

## 1. Зачем это нужно в учебном проекте

- задачи хранятся рядом с кодом и путешествуют вместе с репозиторием;
- не нужен отдельный веб‑интерфейс;
- удобно фиксировать учебные шаги и проверять ход работы.

## 2. Минимальные команды

```bash
# Создать задачу (с описанием — так сохраняется контекст)
bd create "Добавить индикатор загрузки" \
  --type task --priority 2 \
  --description "Показать состояние Loading при запросе к API"

# Посмотреть список задач
bd list

# Перевести задачу в работу
bd update <id> --status in_progress

# Закрыть задачу
bd close <id>
```

## 3. Единый workflow beads + git (обязательный)

1. **Создайте задачу в beads** перед началом работы.
2. **Отметьте задачу как in_progress**.
3. Внесите изменения в документацию или код.
4. **Добавьте изменения в индекс** (`git add -A`).
5. **Сделайте commit проекта** по правилам ниже.
6. **Закройте задачу** после завершения.
7. **Выполните `bd sync`**, если синхронизация не прошла автоматически.

Beads умеет автоматически синхронизироваться с git через хуки. Проверьте,
что хуки установлены:

```bash
bd hooks install
```

Если хуки не установлены или были удалены, выполните команду ещё раз.

## 3.1. Рекомендуемый режим по документации beads

Разработчики beads рекомендуют **автоматический режим синхронизации**:

1. **Auto‑sync** базы и `.beads/issues.jsonl` (происходит автоматически).
2. **Git‑хуки** обеспечивают согласованность перед commit/push и после merge.
3. **Merge‑driver** для `.beads/issues.jsonl`, чтобы не решать конфликты вручную.

Что нужно сделать один раз:

```bash
bd init
bd hooks install

git config merge.beads.driver true
```

Ручные команды `bd sync / bd export / bd import` используются только как
резервный вариант, если auto‑sync/хуки по какой‑то причине не сработали.
Если используется `bd sync`, он сам делает commit и push для
`.beads/issues.jsonl`, поэтому отдельные `git commit` и `git push`
для этих данных не требуются. Коммит проекта выполняется вручную.
`bd sync` не выполняет `git add`, поэтому новые файлы нужно добавить
в индекс заранее.

## 4. Что хранится в репозитории

- `.beads/issues.jsonl` — журнал задач (отслеживается git).
- `.beads/metadata.json` — техническая информация.

## 5. Типичные проблемы

### Ошибка: "LEGACY DATABASE DETECTED"

Эта ошибка означает, что база beads была создана в старой версии
и не содержит идентификатор репозитория.

Исправление для текущего репозитория:
```bash
bd migrate --update-repo-id
```

Если это свежий клон и история задач не нужна:
```bash
rm -rf .beads && bd init
```

## 6. Рекомендации по учебной работе

- Фиксируйте каждую значимую задачу в beads.
- Делайте небольшие коммиты с понятными сообщениями.
- Не удаляйте `.beads/issues.jsonl` без согласования с преподавателем.

## 6.1. Правила сообщения коммита (issue → commit)

Требование:
- первая строка коммита **совпадает с заголовком issue**;
- тело коммита **совпадает с `--description`**;
- после описания идёт **список изменённых файлов**.

Шаблон:
```bash
TITLE="<issue title>"
DESC="<issue description>"
FILES=$(git diff --cached --name-only | sed 's/^/- /')
printf "%s\n\n%s\n\nИзменения:\n%s\n" "$TITLE" "$DESC" "$FILES" | git commit -F -
```

## 7. Памятка: как писать описание задачи

Хорошее описание отвечает на вопросы **что** и **зачем**.

**Примеры:**

✅ Хорошо:
- `--description "Добавить поле базового URL, чтобы менять адрес API без сборки"`
- `--description "Показывать сетевую ошибку понятным текстом"`

❌ Плохо:
- `--description "Сделать задачу"`
- `--description "Нужно исправить"`
