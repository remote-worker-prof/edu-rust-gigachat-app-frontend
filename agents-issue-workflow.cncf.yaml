id: agents-issue-workflow
version: "1.0"
specVersion: "0.8"
name: "Agent Issues + Git + Beads Workflow"
description: "Strict order for issues, work, stage, commit, and sync (commit header: [<id>] <type>(P#): <title>; body: description; file list appended)"
start: createIssue
states:
  - name: createIssue
    type: operation
    actions:
      - name: bdCreate
        functionRef:
          refName: bdCreate
    transition: markInProgress

  - name: markInProgress
    type: operation
    actions:
      - name: bdInProgress
        functionRef:
          refName: bdUpdateInProgress
    transition: doWork

  - name: doWork
    type: operation
    actions:
      - name: implement
        functionRef:
          refName: workImplementation
      - name: test
        functionRef:
          refName: runTests
      - name: fix
        functionRef:
          refName: applyFixes
    transition: stageChanges

  - name: stageChanges
    type: operation
    actions:
      - name: gitAdd
        functionRef:
          refName: gitAdd
    transition: commitChanges

  - name: commitChanges
    type: operation
    actions:
      - name: gitCommit
        functionRef:
          refName: gitCommit
    transition: closeIssue

  - name: closeIssue
    type: operation
    actions:
      - name: bdClose
        functionRef:
          refName: bdClose
    transition: syncBeads

  - name: syncBeads
    type: operation
    actions:
      - name: bdSync
        functionRef:
          refName: bdSync
    end: true

functions:
  - name: bdCreate
    operation: "shell:bd create <title> --type task --priority 2 --description <why>"
  - name: bdUpdateInProgress
    operation: "shell:bd update <id> --status in_progress"
  - name: workImplementation
    operation: "shell:perform implementation"
  - name: runTests
    operation: "shell:run tests"
  - name: applyFixes
    operation: "shell:apply fixes"
  - name: gitAdd
    operation: "shell:git add -A"
  - name: gitCommit
    operation: "shell:ID=<issue_id>; TYPE=<issue_type>; PRIO=<issue_priority>; TITLE=<issue_title>; DESC=<issue_description>; HEADER=\"[$ID] $TYPE($PRIO): $TITLE\"; FILES=$(git diff --cached --name-status | awk '{code=$1; from=$2; to=$3; status=\"изменён\"; if (code ~ /^A/) status=\"создан\"; else if (code ~ /^D/) status=\"удалён\"; else if (code ~ /^R/) { status=\"переименован\"; printf \"- %s %s -> %s (%s)\\n\", code, from, to, status; next } else if (code ~ /^C/) { status=\"скопирован\"; printf \"- %s %s -> %s (%s)\\n\", code, from, to, status; next } printf \"- %s %s (%s)\\n\", code, from, status }'); printf \"%s\\n\\n%s\\n\\nИзменения:\\n%s\\n\" \"$HEADER\" \"$DESC\" \"$FILES\" | git commit -F -"
  - name: bdClose
    operation: "shell:bd close <id>"
  - name: bdSync
    operation: "shell:bd sync"
